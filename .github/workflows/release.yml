name: 发布新版本

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发，如 v1.0.0

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 打包为 EXE
      run: |
        pyinstaller build.spec --clean
    
    - name: 获取版本号
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: 重命名文件
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Move-Item "dist\Excel导入工具.exe" "dist\Excel导入工具-$version.exe"
    
    - name: 创建 Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Excel导入工具-${{ steps.get_version.outputs.VERSION }}.exe
        body: |
          ## Excel 运势数据导入工具 ${{ steps.get_version.outputs.VERSION }}
          
          ### 下载
          
          点击下方的 `Excel导入工具-${{ steps.get_version.outputs.VERSION }}.exe` 下载
          
          ### 使用说明
          
          1. 下载 exe 文件
          2. 双击运行（无需安装）
          3. 点击"环境配置"设置 API 地址
          4. 选择文件并导入
          
          ### 系统要求
          
          - Windows 7 或更高版本
          - 无需安装 Python 或任何依赖
          
          ### 功能特性
          
          - ✅ 支持三种导入类型（每日/每周/每月运势）
          - ✅ 支持四种环境（dev/test/pre/prod）
          - ✅ 可视化环境配置
          - ✅ 实时日志显示
          - ✅ 深色模式界面
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
